# ğŸš€ Auto-Release CORRIGÃ‰ - Permissions et API Moderne
name: Auto Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Ã  releaser (ex: v1.0.0)'
        required: true
        default: 'v1.0.0'
      build_type:
        description: 'Type de build'
        required: true
        default: 'public'
        type: choice
        options:
          - public    # Build sans credentials (distributable)
          - private   # Build avec credentials (usage personnel)

# ğŸ”‘ PERMISSIONS CRUCIALES - C'Ã©tait Ã§a le problÃ¨me !
permissions:
  contents: write    # Pour crÃ©er des releases et tags
  actions: read      # Pour lire les actions
  packages: write    # Pour les packages (optionnel)

env:
  APP_NAME: "ZymoSync"
  PYTHON_VERSION: "3.9"

jobs:
  build-and-release:
    name: ğŸ”¨ Build et Release (CORRIGÃ‰)
    runs-on: windows-latest

    steps:
    # ===== Ã‰TAPE 1: PRÃ‰PARATION =====
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ·ï¸ Extraire la version
      id: version
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
          BUILD_TYPE="${{ github.event.inputs.build_type }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
          BUILD_TYPE="public"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
        
        CLEAN_VERSION=${VERSION#v}
        echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
        
        echo "ğŸ“¦ Version: $VERSION"
        echo "ğŸ”’ Type: $BUILD_TYPE"

    # ===== Ã‰TAPE 2: SETUP =====
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Installer les dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # ===== Ã‰TAPE 3: CREDENTIALS SÃ‰CURISÃ‰S =====
    - name: ğŸ”‘ Setup Credentials
      run: |
        Write-Host "ğŸ”‘ Configuration des credentials..."
        
        if (!(Test-Path "resources")) { 
          New-Item -ItemType Directory -Path "resources" 
        }
        
        $BUILD_TYPE = "${{ steps.version.outputs.build_type }}"
        
        if ($BUILD_TYPE -eq "private") {
          if ("${{ secrets.GOOGLE_CREDENTIALS_JSON }}" -ne "") {
            Write-Host "ğŸ” BUILD PRIVÃ‰: Utilisation des vrais credentials"
            
            # CrÃ©er credentials.json depuis les secrets
            $credentials = @'
        ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        '@
            
            $credentials | Out-File -FilePath "resources/credentials.json" -Encoding UTF8
            echo "CREDENTIALS_STATUS=real" >> $env:GITHUB_ENV
          } else {
            Write-Host "âŒ ERREUR: Build privÃ© demandÃ© mais pas de secret GOOGLE_CREDENTIALS_JSON"
            exit 1
          }
        } else {
          Write-Host "ğŸŒ BUILD PUBLIC: CrÃ©ation d'un template"
          
          # Template pour build public
          $template = @'
        {
          "installed": {
            "client_id": "REMPLACEZ_PAR_VOTRE_CLIENT_ID.apps.googleusercontent.com",
            "project_id": "remplacez-par-votre-projet-id",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_secret": "REMPLACEZ_PAR_VOTRE_CLIENT_SECRET",
            "redirect_uris": ["http://localhost"]
          }
        }
        '@
          
          $template | Out-File -FilePath "resources/credentials.json" -Encoding UTF8
          echo "CREDENTIALS_STATUS=template" >> $env:GITHUB_ENV
        fi
        
        echo "BUILD_TYPE=$BUILD_TYPE" >> $env:GITHUB_ENV

    - name: ğŸ“ CrÃ©er guide utilisateur (build public)
      if: steps.version.outputs.build_type == 'public'
      run: |
        $guide = @'
        # ğŸ”‘ CONFIGURATION GOOGLE DRIVE API REQUISE
        
        ## âš ï¸ Ã‰TAPE OBLIGATOIRE AVANT UTILISATION
        
        Cette application nÃ©cessite vos propres credentials Google Drive API.
        
        ### ğŸš€ Configuration Rapide (5 minutes)
        
        1. **CrÃ©er projet Google Cloud**
           - Allez sur: https://console.cloud.google.com/
           - CrÃ©ez un nouveau projet
           - Activez l'API Google Drive
        
        2. **CrÃ©er credentials OAuth 2.0**
           - Dans le projet: APIs & Services > Credentials
           - Cliquez: Create Credentials > OAuth 2.0 Client ID
           - Type: Desktop Application
           - TÃ©lÃ©chargez le fichier JSON
        
        3. **Installer vos credentials**
           - Renommez le fichier en: credentials.json
           - Remplacez le fichier credentials.json dans ce dossier
           - Lancez ZymoSync.exe
        
        ### ğŸ”’ Pourquoi cette Ã©tape?
        Pour votre sÃ©curitÃ©! Chaque utilisateur garde ses propres credentials privÃ©s.
        
        ### ğŸ†˜ Besoin d'aide?
        Documentation complÃ¨te: https://github.com/votre-repo
        '@
        
        $guide | Out-File -FilePath "SETUP_GUIDE.txt" -Encoding UTF8

    # ===== Ã‰TAPE 4: BUILD =====
    - name: ğŸ§¹ Nettoyer
      run: |
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        Get-ChildItem -Filter "*.spec" | Remove-Item -Force

    - name: ğŸ”¨ Build PyInstaller
      run: |
        Write-Host "ğŸš€ Build en cours..."
        
        pyinstaller --onedir --windowed `
          --hidden-import=googleapiclient.discovery `
          --hidden-import=googleapiclient.http `
          --hidden-import=google.auth.transport.requests `
          --hidden-import=google.oauth2.credentials `
          --hidden-import=charset_normalizer.md__mypyc `
          --hidden-import=sip `
          --collect-all PyQt5 `
          --add-data "resources\credentials.json;." `
          --name ${{ env.APP_NAME }} `
          main.py
          
        Write-Host "âœ… Build terminÃ©"

    - name: âœ… VÃ©rification
      run: |
        $exe = "dist\${{ env.APP_NAME }}\${{ env.APP_NAME }}.exe"
        if (Test-Path $exe) {
          Write-Host "âœ… Exe crÃ©Ã©: $exe"
          $size = (Get-Item $exe).Length / 1MB
          Write-Host "ğŸ“ Taille: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "âŒ Exe non trouvÃ©"
          exit 1
        }

    # ===== Ã‰TAPE 5: ARCHIVE =====
    - name: ğŸ“¦ CrÃ©er ZIP
      run: |
        $VERSION = "${{ steps.version.outputs.clean_version }}"
        $TYPE = "${{ env.BUILD_TYPE }}"
        
        if ($TYPE -eq "private") {
          $NAME = "${{ env.APP_NAME }}-v$VERSION-Windows-Ready"
        } else {
          $NAME = "${{ env.APP_NAME }}-v$VERSION-Windows-Setup"
          # Ajouter le guide pour build public
          Copy-Item "SETUP_GUIDE.txt" "dist\${{ env.APP_NAME }}\"
        }
        
        $ZIP_FILE = "$NAME.zip"
        Compress-Archive -Path "dist\${{ env.APP_NAME }}\*" -DestinationPath $ZIP_FILE
        
        Write-Host "âœ… ZIP crÃ©Ã©: $ZIP_FILE"
        
        echo "ZIP_FILE=$ZIP_FILE" >> $env:GITHUB_ENV
        echo "ZIP_NAME=$NAME" >> $env:GITHUB_ENV

    # ===== Ã‰TAPE 6: RELEASE MODERNE (CORRIGÃ‰E) =====
    - name: ğŸ“ PrÃ©parer changelog
      id: changelog
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        TYPE="${{ env.BUILD_TYPE }}"
        
        BODY="## ğŸš€ Release $VERSION\n\n"
        BODY+="ğŸ“… **Date**: $(date '+%Y-%m-%d %H:%M')\n"
        BODY+="ğŸ”’ **Type**: $(echo $TYPE | tr '[:lower:]' '[:upper:]') build\n\n"
        
        if [[ "$TYPE" == "private" ]]; then
          BODY+="### âœ… PrÃªt Ã  Utiliser\n"
          BODY+="Build avec credentials intÃ©grÃ©s - lancez directement l'exe!\n\n"
        else
          BODY+="### âš™ï¸ Configuration Requise\n"
          BODY+="**IMPORTANT**: Suivez les instructions dans SETUP_GUIDE.txt\n"
          BODY+="Vous devez configurer vos credentials Google Drive API.\n\n"
        fi
        
        BODY+="### ğŸ“¦ Installation\n"
        BODY+="1. TÃ©lÃ©chargez le ZIP ci-dessous\n"
        BODY+="2. Extrayez dans un dossier\n"
        if [[ "$TYPE" == "public" ]]; then
          BODY+="3. **OBLIGATOIRE**: Suivez SETUP_GUIDE.txt\n"
          BODY+="4. Lancez ${{ env.APP_NAME }}.exe\n"
        else
          BODY+="3. Lancez ${{ env.APP_NAME }}.exe\n"
        fi
        
        # Ã‰chapper pour JSON
        BODY_ESCAPED=$(echo -e "$BODY" | sed 's/"/\\"/g' | tr '\n' ' ')
        echo "body=$BODY_ESCAPED" >> $GITHUB_OUTPUT

    - name: ğŸ‰ CrÃ©er Release (API Moderne)
      id: create_release
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const tag = "${{ steps.version.outputs.version }}";
          const name = "ğŸš€ ${{ env.APP_NAME }} ${{ steps.version.outputs.version }}";
          const body = `${{ steps.changelog.outputs.body }}`;
          
          console.log('ğŸ¯ CrÃ©ation de la release...');
          console.log('Tag:', tag);
          console.log('Nom:', name);
          
          try {
            const release = await github.rest.repos.createRelease({
              owner,
              repo,
              tag_name: tag,
              name: name,
              body: body,
              draft: false,
              prerelease: false
            });
            
            console.log('âœ… Release crÃ©Ã©e:', release.data.html_url);
            
            // Stocker l'ID et URL pour l'Ã©tape suivante
            core.setOutput('release_id', release.data.id);
            core.setOutput('upload_url', release.data.upload_url);
            core.setOutput('html_url', release.data.html_url);
            
          } catch (error) {
            console.error('âŒ Erreur crÃ©ation release:', error);
            throw error;
          }

    - name: ğŸ“ Upload ZIP vers Release
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const zipFile = '${{ env.ZIP_FILE }}';
          const uploadUrl = '${{ steps.create_release.outputs.upload_url }}';
          
          console.log('ğŸ“ Upload du ZIP:', zipFile);
          
          try {
            // Lire le fichier
            const data = fs.readFileSync(zipFile);
            
            // Upload vers la release
            const response = await github.rest.repos.uploadReleaseAsset({
              url: uploadUrl,
              headers: {
                'content-type': 'application/zip',
                'content-length': data.length
              },
              name: path.basename(zipFile),
              data: data
            });
            
            console.log('âœ… ZIP uploadÃ©:', response.data.browser_download_url);
            
          } catch (error) {
            console.error('âŒ Erreur upload ZIP:', error);
            throw error;
          }

    # ===== Ã‰TAPE 7: CONFIRMATION =====
    - name: ğŸ‰ Confirmation
      run: |
        Write-Host "ğŸ‰ RELEASE CRÃ‰Ã‰E AVEC SUCCÃˆS! ğŸ‰"
        Write-Host ""
        Write-Host "ğŸ“¦ Version: ${{ steps.version.outputs.version }}"
        Write-Host "ğŸ”’ Type: ${{ env.BUILD_TYPE }}"
        Write-Host "ğŸ“ ZIP: ${{ env.ZIP_FILE }}"
        Write-Host "ğŸ”— Release: ${{ steps.create_release.outputs.html_url }}"
        Write-Host ""
        Write-Host "âœ… Votre app est maintenant disponible au tÃ©lÃ©chargement!"