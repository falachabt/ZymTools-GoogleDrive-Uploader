# ğŸš€ Auto-Release PRIVÃ‰ UNIQUEMENT
name: Auto Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'test-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Ã  releaser (ex: v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  actions: read

env:
  APP_NAME: "ZymoSync"
  PYTHON_VERSION: "3.9"

jobs:
  private-build:
    name: ğŸ”¨ Build PrivÃ© avec Credentials
    runs-on: windows-latest

    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ·ï¸ Extraire la version
      id: version
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        CLEAN_VERSION=${VERSION#v}
        echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
        
        echo "ğŸ“¦ Version: $VERSION"

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Installer les dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # ===== CREDENTIALS PRIVÃ‰S UNIQUEMENT =====
    - name: ğŸ”‘ Setup Credentials PrivÃ©s
      shell: bash
      run: |
        echo "ğŸ” Configuration des credentials privÃ©s..."
        
        # CrÃ©er le dossier resources
        mkdir -p resources
        
        # VÃ©rifier que le secret existe
        if [[ -z "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" ]]; then
          echo "âŒ ERREUR: Secret GOOGLE_CREDENTIALS_JSON manquant!"
          echo "ğŸ“ Pour corriger:"
          echo "   1. Allez dans Settings > Secrets and variables > Actions"
          echo "   2. Cliquez 'New repository secret'"
          echo "   3. Nom: GOOGLE_CREDENTIALS_JSON"
          echo "   4. Valeur: Collez le contenu de votre credentials.json"
          exit 1
        fi
        
        echo "âœ… Secret trouvÃ©, crÃ©ation du fichier credentials..."
        
        # Ã‰crire le JSON depuis les secrets (mÃ©thode sÃ©curisÃ©e)
        echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > resources/credentials.json
        
        # VÃ©rifier que le JSON est valide
        if python -m json.tool resources/credentials.json > /dev/null 2>&1; then
          echo "âœ… Credentials JSON valide"
        else
          echo "âŒ ERREUR: JSON credentials invalide dans le secret"
          echo "ğŸ” VÃ©rifiez que le secret contient un JSON valide"
          exit 1
        fi
        
        # VÃ©rifier la prÃ©sence des clÃ©s importantes
        if grep -q "client_id" resources/credentials.json && grep -q "client_secret" resources/credentials.json; then
          echo "âœ… Credentials semblent complets (client_id et client_secret trouvÃ©s)"
        else
          echo "âš ï¸ WARNING: client_id ou client_secret non trouvÃ©s dans les credentials"
        fi
        
        echo "âœ… Credentials privÃ©s configurÃ©s avec succÃ¨s"

    - name: ğŸ§¹ Nettoyer les anciens builds
      run: |
        Write-Host "ğŸ§¹ Nettoyage..."
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        Get-ChildItem -Filter "*.spec" | Remove-Item -Force
        Write-Host "âœ… Nettoyage terminÃ©"

    - name: ğŸ”¨ Build avec PyInstaller
      run: |
        Write-Host "ğŸš€ Build privÃ© en cours..."
        
        pyinstaller --onedir --windowed `
          --hidden-import=googleapiclient.discovery `
          --hidden-import=googleapiclient.http `
          --hidden-import=google.auth.transport.requests `
          --hidden-import=google.oauth2.credentials `
          --hidden-import=charset_normalizer.md__mypyc `
          --hidden-import=sip `
          --collect-all PyQt5 `
          --add-data "resources\credentials.json;." `
          --name ${{ env.APP_NAME }} `
          main.py
          
        Write-Host "âœ… Build terminÃ© avec succÃ¨s"

    - name: âœ… VÃ©rifier le build
      run: |
        $exePath = "dist\${{ env.APP_NAME }}\${{ env.APP_NAME }}.exe"
        $credPath = "dist\${{ env.APP_NAME }}\credentials.json"
        
        if (Test-Path $exePath) {
          Write-Host "âœ… ExÃ©cutable crÃ©Ã©: $exePath"
          $size = (Get-Item $exePath).Length / 1MB
          Write-Host "ğŸ“ Taille exe: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "âŒ ExÃ©cutable non trouvÃ©!"
          Write-Host "ğŸ“ Contenu de dist:"
          Get-ChildItem -Path "dist" -Recurse
          exit 1
        }
        
        if (Test-Path $credPath) {
          Write-Host "âœ… Credentials inclus dans le build"
        } else {
          Write-Host "âŒ WARNING: credentials.json non trouvÃ© dans le build"
        }
        
        # Afficher la structure du build
        Write-Host "ğŸ“ Structure du build final:"
        Get-ChildItem -Path "dist\${{ env.APP_NAME }}" | Select-Object Name, Length | Format-Table

    - name: ğŸ“¦ CrÃ©er ZIP prÃªt Ã  utiliser
      run: |
        $VERSION = "${{ steps.version.outputs.clean_version }}"
        $ZIP_NAME = "${{ env.APP_NAME }}-v$VERSION-Windows-READY"
        $ZIP_FILE = "$ZIP_NAME.zip"
        
        Write-Host "ğŸ“¦ CrÃ©ation du ZIP prÃªt Ã  utiliser..."
        
        # CrÃ©er un README pour le ZIP
        $readme = @"
# ğŸš€ ${{ env.APP_NAME }} v$VERSION - PRÃŠT Ã€ UTILISER
