# ğŸš€ Auto-Release Workflow - Google Drive Explorer
# Ce workflow build automatiquement l'app, crÃ©e un zip et publie une release

name: Auto Release

# ğŸ¯ DÃ©clenchement sur tags de version (v1.0.0, v1.2.3, etc.)
on:
  push:
    tags:
      - 'v*.*.*'
      - 'test-*'  # Pour les tests, vous pouvez utiliser des tags comme test-v1.0.0
  # DÃ©clenchement manuel pour tests
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Ã  releaser (ex: v1.0.0)'
        required: true
        default: 'v1.0.0'

# ğŸŒ Variables d'environnement
env:
  APP_NAME: "ZymoSync"
  PYTHON_VERSION: "3.9"

# ğŸ”§ Jobs
jobs:
  build-and-release:
    name: ğŸ”¨ Build et Release Automatique
    runs-on: windows-latest  # Windows pour correspondre Ã  votre build.bat
    
    steps:
    # ===== Ã‰TAPE 1: PRÃ‰PARATION =====
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Extraire la version du tag
      id: version
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Version Ã  builder: $VERSION"
        
        # Nettoyer la version pour le nom de fichier (enlever le 'v')
        CLEAN_VERSION=${VERSION#v}
        echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Version propre: $CLEAN_VERSION"
        
    # ===== Ã‰TAPE 2: SETUP ENVIRONNEMENT =====
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Installer les dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    # ===== Ã‰TAPE 3: PRÃ‰PARATION DU BUILD =====
    - name: ğŸ”§ PrÃ©parer les ressources
      run: |
        # CrÃ©er le dossier resources s'il n'existe pas
        if (!(Test-Path "resources")) { 
          New-Item -ItemType Directory -Path "resources" 
        }
        
        # Si credentials.json existe Ã  la racine, le copier dans resources
        if (Test-Path "credentials.json") {
          Copy-Item "credentials.json" "resources/" -Force
          Write-Host "âœ… credentials.json copiÃ© dans resources/"
        } else {
          Write-Host "âš ï¸ credentials.json non trouvÃ©, crÃ©ation d'un fichier placeholder"
          '{"placeholder": "Ajoutez votre credentials.json ici"}' | Out-File -FilePath "resources/credentials.json" -Encoding UTF8
        }
        
    - name: ğŸ§¹ Nettoyer les anciens builds
      run: |
        Write-Host "ğŸ§¹ Nettoyage des anciens builds..."
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        Get-ChildItem -Path "." -Filter "*.spec" | Remove-Item -Force
        Write-Host "âœ… Nettoyage terminÃ©"
        
    # ===== Ã‰TAPE 4: BUILD AVEC PYINSTALLER =====
    - name: ğŸ”¨ Build avec PyInstaller (comme build.bat)
      run: |
        Write-Host "ğŸš€ DÃ©marrage du build avec PyInstaller..."
        
        # Variables (adaptÃ©es de votre build.bat)
        $SCRIPT_NAME = "main.py"
        $APP_NAME = "${{ env.APP_NAME }}"
        
        # Chemins Python (GitHub Actions utilise hostedtoolcache)
        $PYTHON_ROOT = python -c "import sys; print(sys.executable.replace('python.exe', ''))"
        $QT_PLUGIN_PATH = "${PYTHON_ROOT}Lib\site-packages\PyQt5\Qt5\plugins"
        
        Write-Host "ğŸ” Python root: $PYTHON_ROOT"
        Write-Host "ğŸ” Qt plugins: $QT_PLUGIN_PATH"
        
        # Commande PyInstaller (adaptÃ©e de votre build.bat)
        pyinstaller --onedir --windowed `
          --hidden-import=googleapiclient.discovery `
          --hidden-import=googleapiclient.http `
          --hidden-import=google.auth.transport.requests `
          --hidden-import=google.oauth2.credentials `
          --hidden-import=charset_normalizer.md__mypyc `
          --hidden-import=sip `
          --collect-all PyQt5 `
          --add-data "resources\credentials.json;." `
          --name $APP_NAME `
          $SCRIPT_NAME
          
        Write-Host "âœ… Build PyInstaller terminÃ©"
        
    # ===== Ã‰TAPE 5: VÃ‰RIFICATION DU BUILD =====
    - name: âœ… VÃ©rifier le build
      run: |
        Write-Host "ğŸ” VÃ©rification du build..."
        
        $DIST_PATH = "dist\${{ env.APP_NAME }}"
        $EXE_PATH = "$DIST_PATH\${{ env.APP_NAME }}.exe"
        
        if (Test-Path $DIST_PATH) {
          Write-Host "âœ… Dossier dist trouvÃ©: $DIST_PATH"
          
          Write-Host "ğŸ“ Contenu du dossier dist:"
          Get-ChildItem -Path $DIST_PATH -Recurse | Select-Object Name, Length, FullName | Format-Table
          
          if (Test-Path $EXE_PATH) {
            Write-Host "âœ… ExÃ©cutable trouvÃ©: $EXE_PATH"
            $exeSize = (Get-Item $EXE_PATH).Length
            Write-Host "ğŸ“ Taille de l'exÃ©cutable: $([math]::Round($exeSize / 1MB, 2)) MB"
          } else {
            Write-Host "âŒ ExÃ©cutable non trouvÃ© Ã  $EXE_PATH"
            exit 1
          }
        } else {
          Write-Host "âŒ Dossier dist non trouvÃ©"
          exit 1
        }
        
    # ===== Ã‰TAPE 6: CRÃ‰ER L'ARCHIVE ZIP =====
    - name: ğŸ“¦ CrÃ©er l'archive ZIP
      run: |
        Write-Host "ğŸ“¦ CrÃ©ation de l'archive ZIP..."
        
        $VERSION = "${{ steps.version.outputs.clean_version }}"
        $ARCHIVE_NAME = "${{ env.APP_NAME }}-v$VERSION-Windows"
        $ARCHIVE_FILE = "$ARCHIVE_NAME.zip"
        $DIST_PATH = "dist\${{ env.APP_NAME }}"
        
        # CrÃ©er le ZIP avec PowerShell
        Compress-Archive -Path "$DIST_PATH\*" -DestinationPath $ARCHIVE_FILE -Force
        
        Write-Host "âœ… Archive crÃ©Ã©e: $ARCHIVE_FILE"
        
        # VÃ©rifier l'archive
        if (Test-Path $ARCHIVE_FILE) {
          $archiveSize = (Get-Item $ARCHIVE_FILE).Length
          Write-Host "ğŸ“ Taille de l'archive: $([math]::Round($archiveSize / 1MB, 2)) MB"
          
          # Stocker le nom pour les Ã©tapes suivantes
          echo "ARCHIVE_FILE=$ARCHIVE_FILE" >> $env:GITHUB_ENV
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $env:GITHUB_ENV
        } else {
          Write-Host "âŒ Erreur: Archive non crÃ©Ã©e"
          exit 1
        }
        
    # ===== Ã‰TAPE 7: CRÃ‰ER LE CHANGELOG =====
    - name: ğŸ“ GÃ©nÃ©rer le changelog
      id: changelog
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        echo "ğŸ“ GÃ©nÃ©ration du changelog pour $VERSION..."
        
        # Trouver le tag prÃ©cÃ©dent
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        # DÃ©but du changelog
        CHANGELOG="## ğŸš€ Release $VERSION\n\n"
        CHANGELOG+="ğŸ“… **Date**: $(date '+%Y-%m-%d %H:%M:%S')\n\n"
        
        if [[ -n "$PREVIOUS_TAG" ]]; then
          CHANGELOG+="### ğŸ”„ Changements depuis $PREVIOUS_TAG:\n\n"
          
          # RÃ©cupÃ©rer les commits entre les tags
          COMMITS=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          
          if [[ -n "$COMMITS" ]]; then
            CHANGELOG+="$COMMITS\n\n"
          else
            CHANGELOG+="- Corrections mineures et amÃ©liorations\n\n"
          fi
        else
          CHANGELOG+="### ğŸ‰ PremiÃ¨re release officielle!\n\n"
          CHANGELOG+="- Interface moderne avec thÃ¨me sombre\n"
          CHANGELOG+="- Navigation bifurcÃ©e (local / Google Drive)\n"
          CHANGELOG+="- Drag & Drop entre local et cloud\n"
          CHANGELOG+="- Gestionnaire de transferts avancÃ©\n"
          CHANGELOG+="- Support des Shared Drives d'entreprise\n\n"
        fi
        
        # Ajouter des informations techniques
        CHANGELOG+="### ğŸ“¦ Contenu de cette release:\n\n"
        CHANGELOG+="- **Fichier**: \`${{ env.ARCHIVE_FILE }}\`\n"
        CHANGELOG+="- **Plateforme**: Windows (x64)\n"
        CHANGELOG+="- **Python**: ${{ env.PYTHON_VERSION }}\n"
        CHANGELOG+="- **PyQt5**: Inclus\n\n"
        
        CHANGELOG+="### ğŸš€ Installation:\n\n"
        CHANGELOG+="1. TÃ©lÃ©charger le fichier ZIP ci-dessous\n"
        CHANGELOG+="2. Extraire dans un dossier de votre choix\n"
        CHANGELOG+="3. ExÃ©cuter \`${{ env.APP_NAME }}.exe\`\n"
        CHANGELOG+="4. Configurer vos credentials Google Drive\n\n"
        
        CHANGELOG+="### âš™ï¸ Configuration Google Drive:\n\n"
        CHANGELOG+="1. CrÃ©er un projet sur [Google Cloud Console](https://console.cloud.google.com/)\n"
        CHANGELOG+="2. Activer l'API Google Drive\n"
        CHANGELOG+="3. CrÃ©er des credentials OAuth 2.0\n"
        CHANGELOG+="4. TÃ©lÃ©charger le fichier JSON et le renommer \`credentials.json\`\n"
        CHANGELOG+="5. Placer le fichier dans le mÃªme dossier que l'exÃ©cutable\n\n"
        
        CHANGELOG+="---\n\n"
        CHANGELOG+="ğŸ’¡ **Besoin d'aide?** Consultez le [README](https://github.com/${{ github.repository }}) ou crÃ©ez une [issue](https://github.com/${{ github.repository }}/issues)!"
        
        # Ã‰chapper pour GitHub
        CHANGELOG_ESCAPED=$(echo -e "$CHANGELOG" | sed ':a;N;$!ba;s/\n/\\n/g')
        echo "changelog=$CHANGELOG_ESCAPED" >> $GITHUB_OUTPUT
        
        echo "âœ… Changelog gÃ©nÃ©rÃ©"
        
    # ===== Ã‰TAPE 8: CRÃ‰ER LA RELEASE =====
    - name: ğŸ‰ CrÃ©er la release GitHub
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version }}
        release_name: "ğŸš€ ${{ env.APP_NAME }} ${{ steps.version.outputs.version }}"
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: false
        
    # ===== Ã‰TAPE 9: AJOUTER LE ZIP Ã€ LA RELEASE =====
    - name: ğŸ“ Ajouter le ZIP Ã  la release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ env.ARCHIVE_FILE }}
        asset_name: ${{ env.ARCHIVE_FILE }}
        asset_content_type: application/zip
        
    # ===== Ã‰TAPE 10: CONFIRMATION =====
    - name: ğŸ‰ Confirmation finale
      run: |
        Write-Host "ğŸ‰ RELEASE CRÃ‰Ã‰E AVEC SUCCÃˆS! ğŸ‰"
        Write-Host ""
        Write-Host "ğŸ“¦ Version: ${{ steps.version.outputs.version }}"
        Write-Host "ğŸ“ Archive: ${{ env.ARCHIVE_FILE }}"
        Write-Host "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
        Write-Host ""
        Write-Host "âœ… Les utilisateurs peuvent maintenant tÃ©lÃ©charger votre application!"