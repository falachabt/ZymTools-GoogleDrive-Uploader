# ğŸš€ Auto-Release PRIVÃ‰ UNIQUEMENT
name: Auto Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'test-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Ã  releaser (ex: v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  actions: read

env:
  APP_NAME: "ZymoSync"
  PYTHON_VERSION: "3.9"

jobs:
  private-build:
    name: ğŸ”¨ Build PrivÃ© avec Credentials
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Extraire la version
      id: version
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        CLEAN_VERSION=${VERSION#v}
        echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
        
        echo "ğŸ“¦ Version: $VERSION"
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Installer les dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    # ===== CREDENTIALS PRIVÃ‰S UNIQUEMENT =====
    - name: ğŸ”‘ Setup Credentials PrivÃ©s
      shell: bash
      run: |
        echo "ğŸ” Configuration des credentials privÃ©s..."
        
        # CrÃ©er le dossier resources
        mkdir -p resources
        
        # VÃ©rifier que le secret existe
        if [[ -z "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" ]]; then
          echo "âŒ ERREUR: Secret GOOGLE_CREDENTIALS_JSON manquant!"
          echo "ğŸ“ Pour corriger:"
          echo "   1. Allez dans Settings > Secrets and variables > Actions"
          echo "   2. Cliquez 'New repository secret'"
          echo "   3. Nom: GOOGLE_CREDENTIALS_JSON"
          echo "   4. Valeur: Collez le contenu de votre credentials.json"
          exit 1
        fi
        
        echo "âœ… Secret trouvÃ©, crÃ©ation du fichier credentials..."
        
        # Ã‰crire le JSON depuis les secrets (mÃ©thode sÃ©curisÃ©e)
        echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > resources/credentials.json
        
        # VÃ©rifier que le JSON est valide
        if python -m json.tool resources/credentials.json > /dev/null 2>&1; then
          echo "âœ… Credentials JSON valide"
        else
          echo "âŒ ERREUR: JSON credentials invalide dans le secret"
          echo "ğŸ” VÃ©rifiez que le secret contient un JSON valide"
          exit 1
        fi
        
        # VÃ©rifier la prÃ©sence des clÃ©s importantes
        if grep -q "client_id" resources/credentials.json && grep -q "client_secret" resources/credentials.json; then
          echo "âœ… Credentials semblent complets (client_id et client_secret trouvÃ©s)"
        else
          echo "âš ï¸ WARNING: client_id ou client_secret non trouvÃ©s dans les credentials"
        fi
        
        echo "âœ… Credentials privÃ©s configurÃ©s avec succÃ¨s"
        
    - name: ğŸ§¹ Nettoyer les anciens builds
      run: |
        Write-Host "ğŸ§¹ Nettoyage..."
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        Get-ChildItem -Filter "*.spec" | Remove-Item -Force
        Write-Host "âœ… Nettoyage terminÃ©"
        
    - name: ğŸ”¨ Build avec PyInstaller
      run: |
        Write-Host "ğŸš€ Build privÃ© en cours..."
        
        pyinstaller --onedir --windowed `
          --hidden-import=googleapiclient.discovery `
          --hidden-import=googleapiclient.http `
          --hidden-import=google.auth.transport.requests `
          --hidden-import=google.oauth2.credentials `
          --hidden-import=charset_normalizer.md__mypyc `
          --hidden-import=sip `
          --collect-all PyQt5 `
          --add-data "resources\credentials.json;." `
          --name ${{ env.APP_NAME }} `
          main.py
          
        Write-Host "âœ… Build terminÃ© avec succÃ¨s"
        
    - name: âœ… VÃ©rifier le build
      run: |
        $exePath = "dist\${{ env.APP_NAME }}\${{ env.APP_NAME }}.exe"
        $credPath = "dist\${{ env.APP_NAME }}\credentials.json"
        
        if (Test-Path $exePath) {
          Write-Host "âœ… ExÃ©cutable crÃ©Ã©: $exePath"
          $size = (Get-Item $exePath).Length / 1MB
          Write-Host "ğŸ“ Taille exe: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "âŒ ExÃ©cutable non trouvÃ©!"
          Write-Host "ğŸ“ Contenu de dist:"
          Get-ChildItem -Path "dist" -Recurse
          exit 1
        }
        
        if (Test-Path $credPath) {
          Write-Host "âœ… Credentials inclus dans le build"
        } else {
          Write-Host "âŒ WARNING: credentials.json non trouvÃ© dans le build"
        }
        
        # Afficher la structure du build
        Write-Host "ğŸ“ Structure du build final:"
        Get-ChildItem -Path "dist\${{ env.APP_NAME }}" | Select-Object Name, Length | Format-Table
        
    - name: ğŸ“¦ CrÃ©er ZIP prÃªt Ã  utiliser
      run: |
        $VERSION = "${{ steps.version.outputs.clean_version }}"
        $ZIP_NAME = "${{ env.APP_NAME }}-v$VERSION-Windows-READY"
        $ZIP_FILE = "$ZIP_NAME.zip"
        
        Write-Host "ğŸ“¦ CrÃ©ation du ZIP prÃªt Ã  utiliser..."
        
        # CrÃ©er un README pour le ZIP
        $readme = @"
              # ğŸš€ ${{ env.APP_NAME }} v$VERSION - PRÃŠT Ã€ UTILISER
              
              ## âœ… Installation ImmÃ©diate
                
                1. **Extraire** ce ZIP dans un dossier de votre choix
              2. **Lancer** ${{ env.APP_NAME }}.exe
              3. **Autoriser** l'accÃ¨s Google Drive au premier lancement
              4. **C'est tout !** L'application est prÃªte Ã  utiliser
              
              ## ğŸ”‘ Credentials Inclus
              
              Cette version inclut vos credentials Google Drive API personnels.
              Aucune configuration supplÃ©mentaire n'est nÃ©cessaire.
              
              ## ğŸ†˜ Support
              
              - Documentation: https://github.com/${{ github.repository }}
              - Issues: https://github.com/${{ github.repository }}/issues
              
              ---
              Build privÃ© gÃ©nÃ©rÃ© automatiquement le $(Get-Date -Format "yyyy-MM-dd HH:mm")
        "@
        
        $readme | Out-File -FilePath "dist\${{ env.APP_NAME }}\README.txt" -Encoding UTF8
        
        # CrÃ©er le ZIP
        Compress-Archive -Path "dist\${{ env.APP_NAME }}\*" -DestinationPath $ZIP_FILE -Force
        
        if (Test-Path $ZIP_FILE) {
          $zipSize = (Get-Item $ZIP_FILE).Length / 1MB
          Write-Host "âœ… ZIP crÃ©Ã©: $ZIP_FILE"
          Write-Host "ğŸ“ Taille ZIP: $([math]::Round($zipSize, 1)) MB"
        } else {
          Write-Host "âŒ Erreur: ZIP non crÃ©Ã©"
          exit 1
        }
        
        echo "ZIP_FILE=$ZIP_FILE" >> $env:GITHUB_ENV
        echo "ZIP_NAME=$ZIP_NAME" >> $env:GITHUB_ENV
        
    - name: ğŸ“ GÃ©nÃ©rer changelog
      id: changelog
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        BODY="## ğŸš€ ${{ env.APP_NAME }} $VERSION - Build PrivÃ©\n\n"
        BODY+="ğŸ“… **Date**: $(date '+%Y-%m-%d %H:%M:%S')\n"
        BODY+="ğŸ” **Type**: Build privÃ© avec credentials intÃ©grÃ©s\n\n"
        
        BODY+="### âœ… PrÃªt Ã  Utiliser ImmÃ©diatement\n\n"
        BODY+="Cette version inclut vos credentials Google Drive API personnels.\n"
        BODY+="Aucune configuration supplÃ©mentaire n'est requise!\n\n"
        
        BODY+="### ğŸš€ Installation Ultra-Simple\n\n"
        BODY+="1. **TÃ©lÃ©chargez** le ZIP ci-dessous\n"
        BODY+="2. **Extrayez** dans un dossier de votre choix\n"
        BODY+="3. **Double-cliquez** sur \`${{ env.APP_NAME }}.exe\`\n"
        BODY+="4. **Autorisez** Google Drive au premier lancement\n"
        BODY+="5. **Enjoy!** ğŸ‰\n\n"
        
        # Ajouter les changements depuis la derniÃ¨re version
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        if [[ -n "$PREVIOUS_TAG" ]]; then
          BODY+="### ğŸ”„ NouveautÃ©s depuis $PREVIOUS_TAG\n\n"
          COMMITS=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          if [[ -n "$COMMITS" ]]; then
            BODY+="$COMMITS\n\n"
          else
            BODY+="- AmÃ©liorations internes et corrections\n\n"
          fi
        else
          BODY+="### ğŸ‰ PremiÃ¨re Release Automatique!\n\n"
          BODY+="- Interface moderne avec thÃ¨me sombre\n"
          BODY+="- Navigation bifurcÃ©e (local â†” Google Drive)\n"
          BODY+="- Drag & Drop intuitif\n"
          BODY+="- Gestionnaire de transferts avancÃ©\n"
          BODY+="- Support des Shared Drives d'entreprise\n\n"
        fi
        
        BODY+="### ğŸ“¦ DÃ©tails Techniques\n\n"
        BODY+="- **Plateforme**: Windows x64\n"
        BODY+="- **Python**: ${{ env.PYTHON_VERSION }}\n"
        BODY+="- **PyQt5**: Inclus\n"
        BODY+="- **Credentials**: IntÃ©grÃ©s (prÃªt Ã  utiliser)\n"
        BODY+="- **Fichier**: \`${{ env.ZIP_FILE }}\`\n\n"
        
        BODY+="### ğŸ”’ SÃ©curitÃ©\n\n"
        BODY+="Ce build privÃ© contient vos credentials personnels Google Drive.\n"
        BODY+="Ne partagez pas ce fichier avec d'autres personnes.\n\n"
        
        BODY+="---\n\n"
        BODY+="ğŸ’¡ **Besoin d'aide?** Consultez le README.txt inclus dans le ZIP!"
        
        # Ã‰chapper pour JSON (mÃ©thode simple)
        BODY_ESCAPED=$(echo -e "$BODY" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr '\n' ' ')
        echo "body=$BODY_ESCAPED" >> $GITHUB_OUTPUT
        
    - name: ğŸ‰ CrÃ©er Release PrivÃ©e
      id: create_release
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const tag = "${{ steps.version.outputs.version }}";
          const name = "ğŸ” ${{ env.APP_NAME }} ${{ steps.version.outputs.version }} (PrivÃ©)";
          const body = `${{ steps.changelog.outputs.body }}`;
          
          console.log('ğŸ¯ CrÃ©ation de la release privÃ©e...');
          console.log('Tag:', tag);
          console.log('Nom:', name);
          
          try {
            const release = await github.rest.repos.createRelease({
              owner,
              repo,
              tag_name: tag,
              name: name,
              body: body,
              draft: false,
              prerelease: false
            });
            
            console.log('âœ… Release crÃ©Ã©e:', release.data.html_url);
            
            core.setOutput('release_id', release.data.id);
            core.setOutput('upload_url', release.data.upload_url);
            core.setOutput('html_url', release.data.html_url);
            
          } catch (error) {
            console.error('âŒ Erreur crÃ©ation release:', error);
            throw error;
          }
          
    - name: ğŸ“ Upload ZIP vers Release
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const zipFile = '${{ env.ZIP_FILE }}';
          const uploadUrl = '${{ steps.create_release.outputs.upload_url }}';
          
          console.log('ğŸ“ Upload du ZIP privÃ©:', zipFile);
          
          try {
            const data = fs.readFileSync(zipFile);
            
            const response = await github.rest.repos.uploadReleaseAsset({
              url: uploadUrl,
              headers: {
                'content-type': 'application/zip',
                'content-length': data.length
              },
              name: path.basename(zipFile),
              data: data
            });
            
            console.log('âœ… ZIP uploadÃ©:', response.data.browser_download_url);
            
          } catch (error) {
            console.error('âŒ Erreur upload ZIP:', error);
            throw error;
          }
          
    - name: ğŸ‰ Confirmation Finale
      run: |
        Write-Host ""
        Write-Host "ğŸ‰ğŸ‰ğŸ‰ BUILD PRIVÃ‰ CRÃ‰Ã‰ AVEC SUCCÃˆS! ğŸ‰ğŸ‰ğŸ‰"
        Write-Host ""
        Write-Host "ğŸ“¦ Version: ${{ steps.version.outputs.version }}"
        Write-Host "ğŸ“ Fichier: ${{ env.ZIP_FILE }}"
        Write-Host "ğŸ”— Release: ${{ steps.create_release.outputs.html_url }}"
        Write-Host ""
        Write-Host "âœ… PRÃŠT Ã€ UTILISER:"
        Write-Host "   1. TÃ©lÃ©chargez le ZIP depuis GitHub"
        Write-Host "   2. Extrayez et lancez ${{ env.APP_NAME }}.exe"
        Write-Host "   3. Autorisez Google Drive"
        Write-Host "   4. Enjoy! ğŸš€"
        Write-Host ""
        Write-Host "ğŸ” Build privÃ© avec VOS credentials inclus"
        Write-Host "âš ï¸  Ne partagez pas ce ZIP (contient vos clÃ©s privÃ©es)"